name: System Monitor & Auto-Backup

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v3
        with:
          submodules: false
          fetch-depth: 1
      - name: 🔍 Debug Directory Permissions
        run: |
          echo "🔍 Checking Current User & Groups"
          whoami
          id

          echo "🔍 Checking Home Directory"
          ls -ld ~

          echo "🔍 Checking automation_logs Directory"
          ls -ld automation_logs || echo "🚨 automation_logs NOT FOUND!"

          echo "🔍 Checking backups Directory"
          ls -ld backups || echo "🚨 backups NOT FOUND!"

      - name: 🔧 Fix Permissions for automation_logs
        run: |
          chmod -R 777 automation_logs

      - name: 📂 Verify Files Exist
        run: |
          echo "Current Directory: $(pwd)"
          ls -la

      - name: 🧹 Run Cleanup Script
        run: python3 cleanup_files.py

      - name: 📤 Commit and Push Backup Changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add backups/
          git commit -m "🛠️ Automated backup update [CI]" || echo "No changes to commit"
          git push origin main || echo "No changes to push"
